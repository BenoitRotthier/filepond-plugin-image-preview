/*
 * FilePondPluginImagePreview 1.0.2
 * Licensed under MIT, https://opensource.org/licenses/MIT
 * Please visit https://pqina.nl/filepond for details.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.FilePondPluginImagePreview=t()}(this,function(){"use strict";var e=function(e){return/^image/.test(e.type)&&!/svg/.test(e.type)},t=(function(){function e(e){this.value=e}function t(t){function n(e,t){return new Promise(function(n,r){var c={key:e,arg:t,resolve:n,reject:r,next:null};o?o=o.next=c:(a=o=c,i(e,t))})}function i(n,a){try{var o=t[n](a),c=o.value;c instanceof e?Promise.resolve(c.value).then(function(e){i("next",e)},function(e){i("throw",e)}):r(o.done?"return":"normal",o.value)}catch(u){r("throw",u)}}function r(e,t){switch(e){case"return":a.resolve({value:t,done:!0});break;case"throw":a.reject(t);break;default:a.resolve({value:t,done:!1})}a=a.next,a?i(a.key,a.arg):o=null}var a,o;this._invoke=n,"function"!=typeof t["return"]&&(this["return"]=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype["throw"]=function(e){return this._invoke("throw",e)},t.prototype["return"]=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new t(e.apply(this,arguments))}},await:function(t){return new e(t)}}}(),function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}),n={1:function(){return[1,0,0,1,0,0]},2:function(e){return[-1,0,0,1,e,0]},3:function(e,t){return[-1,0,0,-1,e,t]},4:function(e,t){return[1,0,0,-1,0,t]},5:[0,1,1,0,0,0],6:function(e,t){return[0,1,-1,0,t,0]},7:function(e,t){return[0,-1,-1,0,t,e]},8:function(e){return[0,-1,1,0,0,e]}},i=function(e,i,r,a){a!==-1&&e.transform.apply(e,t(n[a](i,r)))},r=function(e,t,n,r){if(r>=5&&r<=8){var a=[n,t];t=a[0],n=a[1]}var o=document.createElement("canvas"),c=o.getContext("2d");return r>=5&&r<=8?(o.width=n,o.height=t):(o.width=t,o.height=n),c.save(),i(c,t,n,r),c.drawImage(e,0,0,t,n),c.restore(),e.close&&e.close(),o},a=function(e,t,n,i,r){e.drawImage(i,.5*t-r*i.width*.5,.5*n-r*i.height*.5,r*i.width,r*i.height)},o={type:"spring",stiffness:.5,damping:.45,mass:10},c=function(e){return e.utils.createView({name:"image-preview",tag:"canvas",ignoreRect:!0,create:function(e){var t=e.root;t.element.width=0,t.element.height=0},write:e.utils.createRoute({DID_LOAD_PREVIEW_IMAGE:function(e){var t=e.root,n=e.props,i=e.action,o=window.devicePixelRatio,c=i.height/i.width,u=t.rect.inner.width,l=t.query("GET_MAX_PREVIEW_HEIGHT"),f=u*o,d=Math.min(l*o,c*u*o),h=c*u>l;t.element.width=f,t.element.height=d;var s=r(i.data,i.width,i.height,i.orientation),v=d/s.height,p=t.element.getContext("2d");if(h){var w=Math.max(f/s.width,d/s.height);a(p,t.element.width,t.element.height,s,w),p.fillStyle="rgba(20, 20, 20, .85)",p.fillRect(0,0,f,d)}a(p,t.element.width,t.element.height,s,v),setTimeout(function(){t.dispatch("DID_DRAW_PREVIEW_IMAGE",{id:n.id})},250)}}),mixins:{styles:["scaleX","scaleY","opacity"],animations:{scaleX:o,scaleY:o,opacity:{type:"tween",duration:750}}}})},u=function(e){return-.5*(Math.cos(Math.PI*e)-1)},l=function(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:u,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:10,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=1-a,c=t.join(","),l=0;l<=r;l++){var f=l/r,d=a+o*f;e.addColorStop(d,"rgba("+c+", "+i(f)*n+")")}},f=document.createElement("canvas"),d=document.createElement("canvas"),h=document.createElement("canvas"),s=function(e,t,n,i,r){e.width=t,e.height=n;var a=e.getContext("2d"),o=.5*t,c=a.createRadialGradient(o,n+110,n-100,o,n+110,n+100);l(c,i,r,void 0,8,.4),a.save(),a.translate(.5*-t,0),a.scale(2,1),a.fillStyle=c,a.fillRect(0,0,t,n),a.restore()},v=function(e,t){t.width=e.width,t.height=e.height;var n=t.getContext("2d");n.drawImage(e,0,0)},p=500,w=200;s(f,p,w,[40,40,40],.85),s(d,p,w,[196,78,71],1),s(h,p,w,[54,151,99],1);var m=function(e){return e.utils.createView({name:"image-preview-overlay",tag:"div",ignoreRect:!0,create:function(e){var t=e.root;t.ref.overlayShadow=document.createElement("canvas"),v(f,t.ref.overlayShadow),t.ref.overlayError=document.createElement("canvas"),v(d,t.ref.overlayError),t.ref.overlaySuccess=document.createElement("canvas"),v(h,t.ref.overlaySuccess),t.appendChild(t.ref.overlayShadow),t.appendChild(t.ref.overlayError),t.appendChild(t.ref.overlaySuccess)},mixins:{styles:["opacity"],animations:{opacity:{type:"tween",duration:500}}}})},g=function(e,t){var n=new Image;n.onload=function(){t(n.naturalWidth,n.naturalHeight)},n.src=e},E=function(e,t,n,i){var r=Math.min(n/e,i/t);return{width:Math.round(e*r),height:Math.round(t*r)}},I=function(e,t,n,i){g(e,function(e,r){var a=E(e,r,t,n);i(a.width,a.height)})},y=function(){self.onmessage=function(t){e(t.data.message,function(e){self.postMessage({id:t.data.id,message:e})})};var e=function(e,t){var n=e.file;createImageBitmap(n)["catch"](function(e){t(null)}).then(function(e){t(e)})}},_={JPEG:65496,APP1:65505,EXIF:1165519206,TIFF:18761,Orientation:274,Unknown:65280},A=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return e.getUint16(t,n)},R=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return e.getUint32(t,n)},P=function(e,t){var n=new FileReader;n.onload=function(e){var n=new DataView(e.target.result);if(A(n,0)!==_.JPEG)return void t(-1);for(var i=n.byteLength,r=2;r<i;){var a=A(n,r);if(r+=2,a===_.APP1){if(R(n,r+=2)!==_.EXIF)break;var o=A(n,r+=6)===_.TIFF;r+=R(n,r+4,o);var c=A(n,r,o);r+=2;for(var u=0;u<c;u++)if(A(n,r+12*u,o)===_.Orientation)return void t(A(n,r+12*u+8,o))}else{if((a&_.Unknown)!==_.Unknown)break;r+=A(n,r)}}t(-1)},n.readAsArrayBuffer(e.slice(0,65536))},C=function(e){var t=function(t){var n=t.root,i=t.props,r=e.utils,a=(r.createView,r.createWorker),o=r.loadImage,c=i.id,u=n.query("GET_ITEM",c),l=function(e,t,n,i){o(e.fileURL).then(function(e){var r=document.createElement("canvas");r.width=t,r.height=n;var a=r.getContext("2d");a.drawImage(e,0,0,t,n),f(r,t,n,i)})},f=function(e,t,i,r){n.dispatch("DID_LOAD_PREVIEW_IMAGE",{id:c,data:e,width:t,height:i,orientation:r})};P(u.file,function(e){var t=n.rect.element.width*window.devicePixelRatio*2,i=t;I(u.fileURL,t,i,function(t,i){if(e>=5&&e<=8){var r=[i,t];t=r[0],i=r[1]}if(n.dispatch("DID_CALCULATE_PREVIEW_IMAGE_SIZE",{id:c,width:t,height:i}),"createImageBitmap"in window){var o=a(y);o.post({file:u.file,resizeWidth:t,resizeHeight:i},function(n){return n?void f(n,t,i,e):void l(u,t,i,e)})}else l(u,t,i,e)})})},n=function(e){var t=e.root;t.ref.overlay.opacity=1},i=function(e){var t=e.root,n=t.ref.image;n.scaleX=1,n.scaleY=1,n.opacity=1},r=function(t){var n=t.root,i=t.props,r=c(e);n.ref.image=n.appendChildView(n.createChildView(r,{id:i.id,scaleX:1.25,scaleY:1.25,opacity:0}));var a=m(e);n.ref.overlay=n.appendChildView(n.createChildView(a,{opacity:0})),n.dispatch("DID_CREATE_PREVIEW_CONTAINER")};return e.utils.createView({name:"image-preview-wrapper",create:r,write:e.utils.createRoute({DID_LOAD_PREVIEW_IMAGE:n,DID_DRAW_PREVIEW_IMAGE:i,DID_CREATE_PREVIEW_CONTAINER:t})})},D=function(t){var n=t.addFilter,i=t.utils,r=i.Type,a=i.createRoute,o=C(t);return n("CREATE_VIEW",function(n){var i=n.is,r=n.view,c=n.query;if(i("file")&&c("GET_ALLOW_IMAGE_PREVIEW")){var u=function(n){var i=n.root,a=n.props,u=a.id,l=c("GET_ITEM",u);if(l){var f=l.file;if(e(f)){var d="createImageBitmap"in(window||{}),h=c("GET_MAX_PREVIEW_FILE_SIZE");if(!(!d&&h&&f.size>h)){var s=t.views.panel;i.ref.panel=r.appendChildView(r.createChildView(s)),i.ref.panel.element.classList.add("filepond--panel-item"),i.ref.panel.height=10,i.ref.imagePreview=r.appendChildView(r.createChildView(o,{id:u}))}}}},l=function(e){var t=e.root,n=(e.props,e.action),i=t.query("GET_MAX_PREVIEW_HEIGHT"),r=t.rect.element.width/n.width;t.ref.panel.height=Math.min(i,n.height*r)};r.registerWriter(a({DID_LOAD_ITEM:u,DID_CALCULATE_PREVIEW_IMAGE_SIZE:l}))}}),{options:{maxPreviewHeight:[256,r.INT],allowImagePreview:[!0,r.BOOLEAN],maxPreviewFileSize:[null,r.INT]}}};return document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:D})),D});