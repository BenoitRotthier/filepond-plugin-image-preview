/*
 * FilePondPluginImagePreview 1.0.10
 * Licensed under MIT, https://opensource.org/licenses/MIT
 * Please visit https://pqina.nl/filepond for details.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.FilePondPluginImagePreview=t()}(this,function(){"use strict";var e=function(e){return/^image/.test(e.type)},t=(function(){function e(e){this.value=e}function t(t){function n(e,t){return new Promise(function(n,r){var c={key:e,arg:t,resolve:n,reject:r,next:null};o?o=o.next=c:(a=o=c,i(e,t))})}function i(n,a){try{var o=t[n](a),c=o.value;c instanceof e?Promise.resolve(c.value).then(function(e){i("next",e)},function(e){i("throw",e)}):r(o.done?"return":"normal",o.value)}catch(u){r("throw",u)}}function r(e,t){switch(e){case"return":a.resolve({value:t,done:!0});break;case"throw":a.reject(t);break;default:a.resolve({value:t,done:!1})}a=a.next,a?i(a.key,a.arg):o=null}var a,o;this._invoke=n,"function"!=typeof t["return"]&&(this["return"]=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype["throw"]=function(e){return this._invoke("throw",e)},t.prototype["return"]=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new t(e.apply(this,arguments))}},await:function(t){return new e(t)}}}(),function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}),n={1:function(){return[1,0,0,1,0,0]},2:function(e){return[-1,0,0,1,e,0]},3:function(e,t){return[-1,0,0,-1,e,t]},4:function(e,t){return[1,0,0,-1,0,t]},5:function(){return[0,1,1,0,0,0]},6:function(e,t){return[0,1,-1,0,t,0]},7:function(e,t){return[0,-1,-1,0,t,e]},8:function(e){return[0,-1,1,0,0,e]}},i=function(e,i,r,a){a!==-1&&e.transform.apply(e,t(n[a](i,r)))},r=function(e,t,n,r){if(t=Math.round(t),n=Math.round(n),r>=5&&r<=8){var a=[n,t];t=a[0],n=a[1]}var o=document.createElement("canvas"),c=o.getContext("2d");return r>=5&&r<=8?(o.width=n,o.height=t):(o.width=t,o.height=n),c.save(),i(c,t,n,r),c.drawImage(e,0,0,t,n),c.restore(),"close"in e&&e.close(),o},a=function(e){return/^image/.test(e.type)&&!/svg/.test(e.type)},o={type:"spring",stiffness:.5,damping:.45,mass:10},c=function(e){return e.utils.createView({name:"image-preview",tag:"div",ignoreRect:!0,create:function(e){var t=e.root;t.ref.clip=document.createElement("div"),t.element.appendChild(t.ref.clip)},write:e.utils.createRoute({DID_IMAGE_PREVIEW_LOAD:function(e){var t=e.root,n=e.props,i=e.action,o=n.id,c=t.query("GET_ITEM",{id:n.id}),u=c.getMetadata("exif")||{},l=u.orientation||-1,d=i.data,f=d.width,s=d.height;if(l>=5&&l<=8){var p=[s,f];f=p[0],s=p[1]}var E=c.getMetadata("crop")||{rect:{x:0,y:0,width:1,height:1},aspectRatio:s/f},h=window.devicePixelRatio,v=t.query("GET_IMAGE_PREVIEW_HEIGHT"),I=t.query("GET_IMAGE_PREVIEW_MIN_HEIGHT"),_=t.query("GET_IMAGE_PREVIEW_MAX_HEIGHT"),y=t.rect.inner.width,m=s/f,g=y,w=y*m,M=null!==v?v:Math.max(I,Math.min(s,_)),R=M/m,T=a(c.file)?r(i.data,R*h,M*h,l):i.data,A=null!==v?v:Math.max(I,Math.min(y*E.aspectRatio,_)),D=A/E.aspectRatio;D>g&&(D=g,A=D*E.aspectRatio);var G=A/(w*E.rect.height);f=g*G,s=w*G;var P=-E.rect.x*g*G,x=-E.rect.y*w*G;t.ref.clip.style.cssText="\n                    width: "+Math.round(D)+"px;\n                    height: "+Math.round(A)+"px;\n                ",T.style.cssText="\n                    width: "+Math.round(f)+"px;\n                    height: "+Math.round(s)+"px;\n                    transform: translate("+Math.round(P)+"px, "+Math.round(x)+"px) rotateZ(0.00001deg);\n                ",t.ref.clip.appendChild(T),t.dispatch("DID_IMAGE_PREVIEW_DRAW",{id:o})}}),mixins:{styles:["scaleX","scaleY","opacity"],animations:{scaleX:o,scaleY:o,opacity:{type:"tween",duration:750}}}})},u=function(e,t){t.width=e.width,t.height=e.height;var n=t.getContext("2d");n.drawImage(e,0,0)},l=function(e){return e.utils.createView({name:"image-preview-overlay",tag:"canvas",ignoreRect:!0,create:function(e){var t=e.root,n=e.props;u(n.template,t.element)},mixins:{styles:["opacity"],animations:{opacity:{type:"spring",mass:25}}}})},d=function(){self.onmessage=function(t){e(t.data.message,function(e){self.postMessage({id:t.data.id,message:e},[e])})};var e=function(e,t){fetch(e.file).then(function(e){return e.blob()}).then(function(e){return createImageBitmap(e)}).then(function(e){return t(e)})}},f=function(e,t){var n=new Image;n.onload=function(){var e=n.naturalWidth,i=n.naturalHeight;n=null,t(e,i)},n.src=e},s=function(e){return-.5*(Math.cos(Math.PI*e)-1)},p=function(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:s,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:10,a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0,o=1-a,c=t.join(","),u=0;u<=r;u++){var l=u/r,d=a+o*l;e.addColorStop(d,"rgba("+c+", "+i(l)*n+")")}},E=function(e,t,n,i,r){e.width=t,e.height=n;var a=e.getContext("2d"),o=.5*t,c=a.createRadialGradient(o,n+110,n-100,o,n+110,n+100);p(c,i,r,void 0,8,.4),a.save(),a.translate(.5*-t,0),a.scale(2,1),a.fillStyle=c,a.fillRect(0,0,t,n),a.restore()},h="undefined"!=typeof navigator,v=500,I=200,_=h&&document.createElement("canvas"),y=h&&document.createElement("canvas"),m=h&&document.createElement("canvas");h&&(E(_,v,I,[40,40,40],.85),E(y,v,I,[196,78,71],1),E(m,v,I,[54,151,99],1));var g=function(e){return"createImageBitmap"in window&&a(e)},w=function(e){var t=l(e),n=function(t){var n=t.root,i=t.props,r=e.utils,a=(r.createView,r.createWorker),o=r.loadImage,c=i.id,u=n.query("GET_ITEM",c),l=URL.createObjectURL(u.file),s=function(e,t,n,i){o(l).then(p)},p=function(e){URL.revokeObjectURL(l),n.dispatch("DID_IMAGE_PREVIEW_LOAD",{id:c,data:e})};f(l,function(e,t){if(n.dispatch("DID_IMAGE_PREVIEW_CALCULATE_SIZE",{id:c,width:e,height:t}),g(u.file)){var i=a(d);i.post({file:l},function(e){return i.terminate(),e?void p(e):void s(u)})}else s(u)})},i=function(e){var t=e.root;t.ref.overlayShadow.opacity=1},r=function(e){var t=e.root,n=t.ref.image;n.scaleX=1,n.scaleY=1,n.opacity=1},a=function(e){var t=e.root;t.ref.overlayShadow.opacity=1,t.ref.overlayError.opacity=0,t.ref.overlaySuccess.opacity=0},o=function(e){var t=e.root;t.ref.overlayShadow.opacity=.25,t.ref.overlayError.opacity=1},u=function(e){var t=e.root;t.ref.overlayShadow.opacity=.25,t.ref.overlaySuccess.opacity=1},s=function(n){var i=n.root,r=n.props,a=c(e);i.ref.image=i.appendChildView(i.createChildView(a,{id:r.id,scaleX:1.25,scaleY:1.25,opacity:0})),i.ref.overlayShadow=i.appendChildView(i.createChildView(t,{template:_,opacity:0})),i.ref.overlaySuccess=i.appendChildView(i.createChildView(t,{template:m,opacity:0})),i.ref.overlayError=i.appendChildView(i.createChildView(t,{template:y,opacity:0}))};return e.utils.createView({name:"image-preview-wrapper",create:s,write:e.utils.createRoute({DID_IMAGE_PREVIEW_LOAD:i,DID_IMAGE_PREVIEW_DRAW:r,DID_IMAGE_PREVIEW_CONTAINER_CREATE:n,DID_THROW_ITEM_LOAD_ERROR:o,DID_THROW_ITEM_PROCESSING_ERROR:o,DID_THROW_ITEM_INVALID:o,DID_COMPLETE_ITEM_PROCESSING:u,DID_START_ITEM_PROCESSING:a,DID_REVERT_ITEM_PROCESSING:a})})},M=function(t){var n=t.addFilter,i=t.utils,r=i.Type,o=i.createRoute,c=i.isFile,u=w(t);return n("CREATE_VIEW",function(t){var n=t.is,i=t.view,r=t.query;if(n("file")&&r("GET_ALLOW_IMAGE_PREVIEW")){var l=function(t){var n=t.root,a=t.props,o=a.id,l=r("GET_ITEM",o);if(l&&c(l.file)){var d=l.file;if(e(d)){var f="createImageBitmap"in(window||{}),s=r("GET_IMAGE_PREVIEW_MAX_FILE_SIZE");!f&&s&&d.size>s||(n.ref.imagePreview=i.appendChildView(i.createChildView(u,{id:o})),n.dispatch("DID_IMAGE_PREVIEW_CONTAINER_CREATE",{id:o}))}}},d=function(e){var t=e.root,n=e.props,i=e.action,r=t.query("GET_ITEM",{id:n.id}),o=r.getMetadata("exif")||{},c=o.orientation||-1,u=i.width,l=i.height;if(c>=5&&c<=8){var d=[l,u];u=d[0],l=d[1]}var f=r.getMetadata("crop")||{rect:{x:0,y:0,width:1,height:1},aspectRatio:l/u},s=t.query("GET_IMAGE_PREVIEW_HEIGHT"),p=t.query("GET_IMAGE_PREVIEW_MIN_HEIGHT"),E=t.query("GET_IMAGE_PREVIEW_MAX_HEIGHT");if(!a(r.file)){var h=2048/u;u*=h,l*=h}l=null!==s?s:Math.max(p,Math.min(l,E)),u=l/f.aspectRatio,u>t.rect.element.width&&(u=t.rect.element.width,l=u*f.aspectRatio),t.ref.imagePreview.element.style.cssText="height:"+Math.round(l)+"px"};i.registerWriter(o({DID_LOAD_ITEM:l,DID_IMAGE_PREVIEW_CALCULATE_SIZE:d}))}}),{options:{allowImagePreview:[!0,r.BOOLEAN],imagePreviewHeight:[null,r.INT],imagePreviewMinHeight:[44,r.INT],imagePreviewMaxHeight:[256,r.INT],imagePreviewMaxFileSize:[null,r.INT]}}};return"undefined"!=typeof navigator&&document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:M})),M});