/*
 * FilePondPluginImagePreview 1.0.1
 * Licensed under MIT, https://opensource.org/licenses/MIT
 * Please visit https://pqina.nl/filepond for details.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.FilePondPluginImagePreview=t()}(this,function(){"use strict";var e=function(e){return/^image/.test(e.type)&&!/svg/.test(e.type)},t=(function(){function e(e){this.value=e}function t(t){function n(e,t){return new Promise(function(n,i){var c={key:e,arg:t,resolve:n,reject:i,next:null};o?o=o.next=c:(a=o=c,r(e,t))})}function r(n,a){try{var o=t[n](a),c=o.value;c instanceof e?Promise.resolve(c.value).then(function(e){r("next",e)},function(e){r("throw",e)}):i(o.done?"return":"normal",o.value)}catch(u){i("throw",u)}}function i(e,t){switch(e){case"return":a.resolve({value:t,done:!0});break;case"throw":a.reject(t);break;default:a.resolve({value:t,done:!1})}a=a.next,a?r(a.key,a.arg):o=null}var a,o;this._invoke=n,"function"!=typeof t["return"]&&(this["return"]=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(t.prototype[Symbol.asyncIterator]=function(){return this}),t.prototype.next=function(e){return this._invoke("next",e)},t.prototype["throw"]=function(e){return this._invoke("throw",e)},t.prototype["return"]=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new t(e.apply(this,arguments))}},await:function(t){return new e(t)}}}(),function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}),n={1:function(){return[1,0,0,1,0,0]},2:function(e){return[-1,0,0,1,e,0]},3:function(e,t){return[-1,0,0,-1,e,t]},4:function(e,t){return[1,0,0,-1,0,t]},5:[0,1,1,0,0,0],6:function(e,t){return[0,1,-1,0,t,0]},7:function(e,t){return[0,-1,-1,0,t,e]},8:function(e){return[0,-1,1,0,0,e]}},r=function(e,r,i,a){a!==-1&&e.transform.apply(e,t(n[a](r,i)))},i=function(e,t,n,i){if(i>=5&&i<=8){var a=[n,t];t=a[0],n=a[1]}var o=document.createElement("canvas"),c=o.getContext("2d");return i>=5&&i<=8?(o.width=n,o.height=t):(o.width=t,o.height=n),c.save(),r(c,t,n,i),c.drawImage(e,0,0,t,n),c.restore(),e.close&&e.close(),o},a=function(e){return e.utils.createView({name:"image-preview",tag:"canvas",create:function(e){var t=e.root;t.element.width=0,t.element.height=0},write:e.utils.createRoute({DID_LOAD_PREVIEW_IMAGE:function(e){var t=e.root,n=e.props,r=e.action;t.element.width=r.width,t.element.height=r.height;var a=t.element.getContext("2d");a.drawImage(i(r.data,t.element.width,t.element.height,r.orientation),0,0),setTimeout(function(){t.dispatch("DID_DRAW_PREVIEW_IMAGE",{id:n.id})},250)}}),mixins:{styles:["scaleX","scaleY","opacity"],animations:{scaleX:{type:"spring",stiffness:.5,damping:.45,mass:10},scaleY:{type:"spring",stiffness:.5,damping:.45,mass:10},opacity:{type:"tween",duration:750}}}})},o=document.createElement("canvas"),c=document.createElement("canvas"),u=document.createElement("canvas"),l=function(e,t,n){var r=500,i=200;e.width=r,e.height=i;var a=e.getContext("2d"),o=.5*r,c=a.createRadialGradient(o,i+110,i-100,o,i+110,i+100);c.addColorStop(.5,"rgba("+t.join(",")+")"),c.addColorStop(1,"rgba("+n.join(",")+")"),a.save(),a.translate(.25*-r,0),a.scale(1.5,1),a.fillStyle=c,a.fillRect(0,0,r,i),a.restore()},f=function(e,t){t.width=e.width,t.height=e.height;var n=t.getContext("2d");n.drawImage(e,0,0)};l(o,[40,40,40,0],[40,40,40,.85]),l(c,[196,78,71,0],[196,78,71,1]),l(u,[54,151,99,0],[54,151,99,1]);var s=function(e){return e.utils.createView({name:"image-preview-overlay",tag:"div",create:function(e){var t=e.root;t.ref.overlayShadow=document.createElement("canvas"),t.appendChild(t.ref.overlayShadow),f(o,t.ref.overlayShadow),t.ref.overlayError=document.createElement("canvas"),t.appendChild(t.ref.overlayError),f(c,t.ref.overlayError),t.ref.overlaySuccess=document.createElement("canvas"),t.appendChild(t.ref.overlaySuccess),f(u,t.ref.overlaySuccess)},mixins:{styles:["opacity"],animations:{opacity:{type:"tween",duration:500}}}})},d=function(e,t){var n=new Image;n.onload=function(){t(n.naturalWidth,n.naturalHeight)},n.src=e},h=function(e,t,n,r){var i=Math.min(n/e,r/t);return{width:Math.round(e*i),height:Math.round(t*i)}},v=function(e,t,n,r){d(e,function(e,i){var a=h(e,i,t,n);r(a.width,a.height)})},p=function(){self.onmessage=function(t){e(t.data.message,function(e){self.postMessage({id:t.data.id,message:e})})};var e=function(e,t){var n=e.file,r=new FileReader;r.onload=function(){var e=new Blob([new Uint8Array(r.result)],{type:n.type});createImageBitmap(e)["catch"](function(e){t(null)}).then(function(e){t(e)})},r.readAsArrayBuffer(n)}},m={JPEG:65496,APP1:65505,EXIF:1165519206,TIFF:18761,Orientation:274,Unknown:65280},w=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return e.getUint16(t,n)},g=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return e.getUint32(t,n)},E=function(e,t){var n=new FileReader;n.onload=function(e){var n=new DataView(e.target.result);if(w(n,0)!==m.JPEG)return void t(-1);for(var r=n.byteLength,i=2;i<r;){var a=w(n,i);if(i+=2,a===m.APP1){if(g(n,i+=2)!==m.EXIF)break;var o=w(n,i+=6)===m.TIFF;i+=g(n,i+4,o);var c=w(n,i,o);i+=2;for(var u=0;u<c;u++)if(w(n,i+12*u,o)===m.Orientation)return void t(w(n,i+12*u+8,o))}else{if((a&m.Unknown)!==m.Unknown)break;i+=w(n,i)}}t(-1)},n.readAsArrayBuffer(e.slice(0,65536))},y=function(e){var t=function(e){var t=e.root,n=e.props,r=e.action,i=t.rect.element.width/r.width;n.height=r.height*i},n=function(e){var t=e.root,n=t.ref.overlay;n.opacity=1},r=function(e){var t=e.root,n=t.ref.image;n.scaleX=1,n.scaleY=1,n.opacity=1},i=function(t){var n=t.root,r=t.props,i=e.utils,o=(i.createView,i.createWorker),c=i.loadImage,u=r.id,l=a(e);n.ref.image=n.appendChildView(n.createChildView(l,{id:r.id,scaleX:1.25,scaleY:1.25,opacity:0}));var f=s(e);n.ref.overlay=n.appendChildView(n.createChildView(f,{opacity:0}));var d=n.query("GET_ITEM",u),h=function(e,t,n,r){c(e.fileURL).then(function(e){var i=document.createElement("canvas");i.width=t,i.height=n;var a=i.getContext("2d");a.drawImage(e,0,0,t,n),m(i,t,n,r)})},m=function(e,t,r,i){n.dispatch("DID_LOAD_PREVIEW_IMAGE",{id:u,data:e,width:t,height:r,orientation:i})};E(d.file,function(e){v(d.fileURL,700,700,function(t,r){if(e>=5&&e<=8){var i=[r,t];t=i[0],r=i[1]}if(n.dispatch("DID_CALCULATE_PREVIEW_IMAGE_SIZE",{id:u,width:t,height:r}),"createImageBitmap"in window){var a=o(p);a.post({file:d.file,resizeWidth:t,resizeHeight:r},function(n){return n?void m(n,t,r,e):void h(d,t,r,e)})}else h(d,t,r,e)})})};return e.utils.createView({name:"image-preview-wrapper",create:i,write:e.utils.createRoute({DID_CALCULATE_PREVIEW_IMAGE_SIZE:t,DID_LOAD_PREVIEW_IMAGE:n,DID_DRAW_PREVIEW_IMAGE:r}),mixins:{apis:["height"],animations:{height:"spring"}}})},I=function(t){var n=t.addFilter,r=t.utils,i=r.Type,a=r.createRoute,o=y(t);n("SET_DEFAULT_OPTIONS",function(e){return Object.assign(e,{allowImagePreview:[!0,i.BOOLEAN],maxPreviewFileSize:[null,i.INT]})}),n("CREATE_VIEW",function(n){var r=n.is,i=n.view,c=n.query;if(r("file")&&c("GET_ALLOW_IMAGE_PREVIEW")){var u=function(n){var r=n.root,a=n.props,u=a.id,l=c("GET_ITEM",u);if(l){var f=l.file;if(e(f)){var s="createImageBitmap"in(window||{}),d=c("GET_MAX_PREVIEW_FILE_SIZE");if(!(!s&&d&&f.size>d)){var h=t.views.panel;r.ref.panel=i.appendChildView(i.createChildView(h)),r.ref.panel.element.classList.add("filepond--panel-item"),r.ref.imagePreview=i.appendChildView(i.createChildView(o,{id:u,height:10}))}}}},l=a({DID_LOAD_ITEM:u}),f=function(e){var t=e.root,n=e.props,r=e.actions;l({root:t,props:n,actions:r}),t.ref.panel&&(t.ref.panel.height=t.ref.imagePreview.height)};i.registerWriter(f)}})};return document&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:I})),I});